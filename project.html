<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - SkillXchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: '#6366f1',
                        brandDark: '#4f46e5',
                        brandLight: '#e0e7ff',
                        bgMain: '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        body { @apply bg-bgMain dark:bg-gray-900 transition-colors duration-300; }
        .sidebar-link { transition: all 0.2s; border-radius: 8px; margin-bottom: 4px; }
        .sidebar-link:hover { background-color: #f3f4f6; color: #4f46e5; }
        html.dark .sidebar-link:hover { background-color: #374151; color: #818cf8; }
        
        /* Custom scrollbar for file tree */
        .file-tree::-webkit-scrollbar { width: 6px; }
        .file-tree::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        html.dark .file-tree::-webkit-scrollbar-thumb { background-color: #4b5563; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-gray-800 dark:text-gray-100 font-sans bg-bgMain dark:bg-gray-900">

    <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col z-30 hidden md:flex shrink-0 transition-colors duration-300">
        <div class="h-16 flex items-center px-6 border-b border-gray-100 dark:border-gray-700 cursor-pointer" onclick="window.location.href='index.html'">
            <div class="w-8 h-8 bg-brand rounded-lg flex items-center justify-center text-white font-bold mr-3 shadow-md">S</div>
            <span class="font-bold text-xl tracking-tight text-gray-900 dark:text-white">SkillXchange</span>
        </div>
        <div class="flex-1 overflow-y-auto py-6 px-4">
            <div onclick="window.location.href='index.html'" class="sidebar-link flex items-center px-3 py-2.5 cursor-pointer text-sm text-gray-600 dark:text-gray-300">
                <i class="fas fa-arrow-left w-6 text-center mr-2"></i> Back to Dashboard
            </div>
        </div>
        <div class="p-4 border-t border-gray-100 dark:border-gray-700">
            <div class="flex items-center">
                <div id="user-avatar" class="w-9 h-9 rounded-full bg-brand text-white flex items-center justify-center font-bold text-sm">G</div>
                <div class="ml-3">
                    <p id="user-name-display" class="text-sm font-semibold text-gray-700 dark:text-gray-200">Guest</p>
                    <p class="text-xs text-green-500">‚óè Online</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative bg-bgMain dark:bg-gray-900">
        
        <header class="h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-8 shadow-sm z-20 shrink-0">
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='index.html'" class="md:hidden text-gray-500"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-lg font-bold text-gray-800 dark:text-white">Project Workspace</h2>
            </div>
            <button onclick="toggleTheme()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-yellow-400 transition">
                <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
                        <div class="h-32 bg-gradient-to-r from-indigo-600 to-purple-600"></div>
                        <div class="p-6 relative">
                            <div class="absolute -top-10 left-6 w-20 h-20 bg-white dark:bg-gray-800 rounded-xl border-4 border-white dark:border-gray-800 flex items-center justify-center text-3xl shadow-md">
                                üöÄ
                            </div>
                            <div class="mt-10 flex justify-between items-start">
                                <div>
                                    <h1 id="p-title" class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Loading...</h1>
                                    <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                                        <span class="flex items-center gap-1"><i class="fas fa-user-circle"></i> <span id="p-author">...</span></span>
                                        <span class="flex items-center gap-1"><i class="far fa-clock"></i> <span id="p-date">...</span></span>
                                    </div>
                                </div>
                                </div>
                            <div class="mt-6">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">About Project</h3>
                                <p id="p-desc" class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">Loading description...</p>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Tech Stack</h3>
                                <div id="p-tags" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col h-[500px]">
                        <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50">
                            <h3 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                                <i class="fab fa-github text-lg"></i> Code Repository
                            </h3>
                            <span class="text-xs text-gray-400 italic" id="repo-status">Waiting for link...</span>
                        </div>
                        <div class="flex flex-1 overflow-hidden">
                            <div class="w-1/3 border-r border-gray-100 dark:border-gray-700 overflow-y-auto file-tree bg-gray-50 dark:bg-gray-800/50 p-2" id="file-tree">
                                </div>
                            <div class="w-2/3 bg-[#1e1e1e] p-4 overflow-auto font-mono text-sm">
                                <pre><code class="text-green-400" id="code-preview">// Select a file to view content...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 h-[80vh] sticky top-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm flex flex-col h-full">
                        <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                            <h3 class="font-bold text-gray-800 dark:text-white">Team Chat</h3>
                            <p class="text-xs text-gray-500">Discuss this project</p>
                        </div>
                        
                        <div id="project-chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50/50 dark:bg-gray-900/50">
                            <p class="text-center text-gray-400 text-xs mt-4">Start the conversation...</p>
                        </div>

                        <div class="p-3 border-t border-gray-100 dark:border-gray-700">
                            <div class="relative">
                                <input type="text" id="chat-input" placeholder="Type message..." 
                                    class="w-full bg-gray-100 dark:bg-gray-700 dark:text-white border-none rounded-lg pl-4 pr-12 py-3 focus:ring-2 focus:ring-brand outline-none"
                                    onkeypress="if(event.key==='Enter') sendProjectMessage()">
                                <button onclick="sendProjectMessage()" class="absolute right-2 top-2 text-brand hover:text-brandDark p-1">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

   <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLafxMmbSanvmgP9KPvWXO7968BgkSMAQ",
            authDomain: "skillxchange-93fac.firebaseapp.com",
            projectId: "skillxchange-93fac",
            storageBucket: "skillxchange-93fac.firebasestorage.app",
            messagingSenderId: "363649168062",
            appId: "1:363649168062:web:a938e95d8c7a684a1de4ef"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = "Guest";
        let projectId = new URLSearchParams(window.location.search).get("id");
        
        // Navigation State
        let currentRepoSlug = "";
        let currentPath = ""; 

        // --- THEME LOGIC ---
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') document.documentElement.classList.add('dark');
        
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // --- LOAD DATA ---
        if (!projectId) {
            alert("No project selected!");
            window.location.href = "index.html";
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    const data = doc.data();
                    currentUser = `${data.firstName} ${data.lastName}`;
                    document.getElementById("user-name-display").innerText = currentUser;
                    document.getElementById("user-avatar").innerText = currentUser.charAt(0).toUpperCase();
                });
            } else {
                window.location.href = "login.html"; 
            }
        });

        // 1. Fetch Project Details
        db.collection("projects").doc(projectId).get().then(doc => {
            if (!doc.exists) {
                document.getElementById("p-title").innerText = "Project not found";
                return;
            }
            const data = doc.data();
            
            // Populate Text
            document.getElementById("p-title").innerText = data.title;
            document.getElementById("p-author").innerText = data.author;
            document.getElementById("p-desc").innerText = data.description;
            document.getElementById("p-date").innerText = data.timestamp ? data.timestamp.toDate().toLocaleDateString() : "Recent";
            
            // Populate Tags
            const tags = (data.techStack || "").split(",");
            document.getElementById("p-tags").innerHTML = tags.map(t => 
                `<span class="px-3 py-1 bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300 text-sm rounded-full font-medium">${t.trim()}</span>`
            ).join("");

            // --- GITHUB LINK LOGIC ---
            if (data.githubLink) {
                let repoSlug = cleanGithubLink(data.githubLink);
                if (repoSlug) {
                    currentRepoSlug = repoSlug;
                    fetchGitHubTree(currentRepoSlug, ""); // Load root
                } else {
                    renderMockFileTree("Invalid GitHub Link format");
                }
            } 
            else {
                // Fallback to description regex
                const githubRegex = /github\.com\/([a-zA-Z0-9-]+\/[a-zA-Z0-9-_]+)/;
                const match = data.description.match(githubRegex);
                if (match) {
                    currentRepoSlug = match[1];
                    fetchGitHubTree(currentRepoSlug, "");
                } else {
                    renderMockFileTree("No GitHub Link provided - Viewing Demo");
                }
            }

            loadProjectChat();
        });

        function cleanGithubLink(link) {
            try {
                let clean = link.replace("https://", "").replace("http://", "").replace("www.", "");
                if (clean.startsWith("github.com/")) {
                    clean = clean.replace("github.com/", "");
                }
                const parts = clean.split("/");
                if (parts.length >= 2) {
                    return `${parts[0]}/${parts[1]}`;
                }
                return null;
            } catch(e) { return null; }
        }

        // --- GITHUB FILE VIEWER NAVIGABLE ---
        async function fetchGitHubTree(repoSlug, path) {
            currentPath = path;
            const displayPath = path ? path : "root";
            document.getElementById("repo-status").innerText = `${repoSlug}/${displayPath}`;
            
            const treeContainer = document.getElementById("file-tree");
            treeContainer.innerHTML = '<p class="text-xs text-gray-500 p-2">Fetching files...</p>';
            
            try {
                // Fetch contents for specific path
                const url = `https://api.github.com/repos/${repoSlug}/contents/${path}`;
                const res = await fetch(url);
                if(!res.ok) throw new Error("Repo not found or private");
                const files = await res.json();
                
                // Sort: Folders first
                files.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                });
                
                let html = '<ul class="space-y-1">';

                // ADD "GO BACK" OPTION IF NOT ROOT
                if (path !== "") {
                     html += `
                        <li onclick="goBack()" class="cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 p-1.5 rounded flex items-center gap-2 text-xs font-bold text-brand dark:text-brandLight transition border-b border-gray-100 dark:border-gray-700 mb-1">
                            <i class="fas fa-level-up-alt"></i> ..
                        </li>`;
                }

                files.forEach(file => {
                    const isDir = file.type === 'dir';
                    
                    // Determine icon based on file type
                    let icon = 'fa-file-code text-gray-400';
                    if (isDir) icon = 'fa-folder text-blue-400';
                    else if (file.name.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i)) icon = 'fa-image text-purple-400';

                    const action = isDir 
                        ? `onclick="openFolder('${file.name}')"` 
                        : `onclick="viewFile('${file.download_url}', '${file.name}')"`;

                    html += `
                        <li ${action} class="cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 p-1.5 rounded flex items-center gap-2 text-xs text-gray-700 dark:text-gray-300 transition">
                            <i class="fas ${icon}"></i> ${file.name}
                        </li>`;
                });
                html += '</ul>';
                treeContainer.innerHTML = html;
            } catch (e) {
                renderMockFileTree(`Error: ${e.message} (Using Demo)`);
            }
        }

        function openFolder(folderName) {
            // Append folder to current path
            const newPath = currentPath ? `${currentPath}/${folderName}` : folderName;
            fetchGitHubTree(currentRepoSlug, newPath);
        }

        function goBack() {
            // Remove last segment from path
            if (!currentPath) return;
            const segments = currentPath.split('/');
            segments.pop(); // remove last
            const newPath = segments.join('/');
            fetchGitHubTree(currentRepoSlug, newPath);
        }

        function renderMockFileTree(statusMsg) {
            document.getElementById("repo-status").innerText = statusMsg;
            const demoFiles = [
                { name: "src", type: "dir" },
                { name: "public", type: "dir" },
                { name: "assets", type: "dir" },
                { name: "App.js", type: "file", content: "import React from 'react';\n\nfunction App() {\n  return <h1>Hello Project!</h1>;\n}" },
                { name: "logo.png", type: "file", isImage: true }, // Mock image
                { name: "README.md", type: "file", content: "# Project Documentation" },
            ];

            let html = '<ul class="space-y-1">';
            demoFiles.forEach(f => {
                let icon = 'fa-file-code text-gray-400';
                if(f.type === 'dir') icon = 'fa-folder text-blue-400';
                if(f.isImage) icon = 'fa-image text-purple-400';

                const content = f.content ? btoa(f.content) : ''; 
                
                let action = '';
                if(f.type === 'dir') action = "onclick=\"alert('Demo navigation limited')\"";
                else if(f.isImage) action = "onclick=\"showMockImage()\"";
                else action = `onclick="showMockCode('${content}')"`;
                
                html += `
                    <li ${action} class="cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 p-1.5 rounded flex items-center gap-2 text-xs text-gray-700 dark:text-gray-300 transition">
                        <i class="fas ${icon}"></i> ${f.name}
                    </li>`;
            });
            html += '</ul>';
            document.getElementById("file-tree").innerHTML = html;
        }

        // --- UPDATED VIEW FILE FUNCTION ---
        async function viewFile(url, name) {
            if(!url) return;
            const previewBox = document.getElementById("code-preview");
            
            // CHECK IF IMAGE
            const imageExts = ['.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp'];
            const isImage = imageExts.some(ext => name.toLowerCase().endsWith(ext));

            // RESET VIEW (Clear previous content or loading text)
            // Note: We use innerHTML for images, innerText for code to prevent XSS
            if (isImage) {
                previewBox.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-4">
                        <img src="${url}" class="max-w-full max-h-[400px] object-contain rounded-lg shadow-lg border border-gray-700 bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                        <p class="text-gray-500 text-xs mt-4 font-mono">${name}</p>
                    </div>`;
                return;
            }

            // IF TEXT FILE
            previewBox.innerHTML = `<pre><code class="text-green-400" id="code-content">// Loading ${name}...</code></pre>`;
            try {
                const res = await fetch(url);
                const text = await res.text();
                const displayText = text.length > 50000 ? text.substring(0, 50000) + "\n... (File too large)" : text;
                document.getElementById("code-content").innerText = displayText;
            } catch(e) {
                document.getElementById("code-content").innerText = "// Error loading file content.";
            }
        }

        function showMockCode(encoded) {
             document.getElementById("code-preview").innerHTML = `<pre><code class="text-green-400">${atob(encoded)}</code></pre>`;
        }
        
        function showMockImage() {
            document.getElementById("code-preview").innerHTML = `
                <div class="h-full flex flex-col items-center justify-center p-4">
                    <div class="w-32 h-32 bg-purple-500 rounded-lg flex items-center justify-center text-white shadow-lg">
                        <i class="fas fa-image text-4xl"></i>
                    </div>
                    <p class="text-gray-500 text-xs mt-4 font-mono">demo-image.png</p>
                </div>`;
        }

        // --- CHAT LOGIC ---
        function loadProjectChat() {
            const box = document.getElementById("project-chat-box");
            db.collection("projects").doc(projectId).collection("messages")
              .orderBy("timestamp", "asc")
              .onSnapshot(snap => {
                  box.innerHTML = "";
                  if(snap.empty) {
                      box.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Be the first to say hello!</p>';
                  }
                  snap.forEach(doc => {
                      const msg = doc.data();
                      const isMe = msg.user === currentUser;
                      box.innerHTML += `
                        <div class="flex flex-col ${isMe ? "items-end" : "items-start"} mb-2">
                            <span class="text-[10px] text-gray-400 mb-0.5 px-1">${msg.user}</span>
                            <div class="px-3 py-2 rounded-lg text-xs max-w-[85%] ${isMe ? "bg-brand text-white" : "bg-gray-200 dark:bg-gray-700 dark:text-white"}">
                                ${msg.text}
                            </div>
                        </div>
                      `;
                  });
                  box.scrollTop = box.scrollHeight;
              });
        }

        function sendProjectMessage() {
            const input = document.getElementById("chat-input");
            const text = input.value.trim();
            if(!text) return;

            db.collection("projects").doc(projectId).collection("messages").add({
                text: text,
                user: currentUser,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }
    </script>
</body>
</html>