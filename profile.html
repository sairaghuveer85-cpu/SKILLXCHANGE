<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | SkillXchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: '#6366f1',
                        brandDark: '#4f46e5',
                        brandLight: '#e0e7ff',
                        bgMain: '#f3f4f6',
                    }
                }
            }
        }
    </script>
   
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        
        /* Dark mode scrollbar overrides */
        html.dark ::-webkit-scrollbar-track { background: #1f2937; }
        html.dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel { 
            background: white; 
            border: 1px solid #e5e7eb; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Dark mode override for glass-panel */
        html.dark .glass-panel {
            background: #1f2937; /* gray-800 */
            border-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="bg-bgMain dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 h-16 flex items-center justify-between px-6 shrink-0 z-50 transition-colors duration-300">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-brand transition font-medium">
                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-brandLight dark:hover:bg-gray-600 hover:text-brand">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <span class="hidden sm:inline">Back to Feed</span>
            </a>
            <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-2 hidden sm:block"></div>
            <h1 class="text-xl font-bold text-gray-800 dark:text-white tracking-tight">Profile</h1>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-yellow-400 transition hover:bg-gray-200 dark:hover:bg-gray-600 mr-2">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>

            <button id="edit-profile-btn" onclick="toggleEditModal()" class="flex items-center gap-2 px-4 py-2 bg-brandLight dark:bg-gray-700 text-brand dark:text-brandLight rounded-lg font-semibold text-sm hover:bg-brand hover:text-white dark:hover:bg-brandDark transition">
                <i class="fas fa-pen"></i> <span class="hidden sm:inline">Edit Profile</span>
            </button>
            <div class="w-9 h-9 rounded-full bg-brand text-white flex items-center justify-center font-bold text-sm">
                <span id="nav-avatar">U</span>
            </div>
        </div>
    </nav>

    <div class="flex-1 overflow-hidden">
        <div class="h-full w-full max-w-[1600px] mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

            <aside class="lg:col-span-4 xl:col-span-3 h-full overflow-y-auto lg:overflow-hidden flex flex-col gap-4">
                <div class="glass-panel rounded-2xl overflow-hidden relative flex-shrink-0">
                    <div class="h-32 bg-gradient-to-r from-blue-500 via-brand to-purple-500"></div>
                    
                    <div class="px-6 pb-6 text-center relative">
                        <div class="w-28 h-28 rounded-full border-4 border-white dark:border-gray-800 bg-white dark:bg-gray-800 mx-auto -mt-14 shadow-md flex items-center justify-center overflow-hidden relative group transition-colors duration-300">
                            <span id="profile-avatar-text" class="text-4xl font-bold text-gray-400">?</span>
                            <img id="profile-img-tag" class="hidden w-full h-full object-cover"> 
                            
                            <div id="photo-overlay" onclick="document.getElementById('photo-upload').click()" class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer hidden">
                                <i class="fas fa-camera text-white text-xl"></i>
                            </div>
                            <input type="file" id="photo-upload" class="hidden" accept="image/*" onchange="uploadPhoto(this)">
                        </div>

                        <div class="mt-3">
                            <h2 id="profile-name" class="text-2xl font-bold text-gray-900 dark:text-white">Loading...</h2>
                            <p id="profile-headline" class="text-gray-500 dark:text-gray-400 text-sm mt-1"></p>
                            <div class="flex items-center justify-center gap-2 mt-2 text-xs text-gray-400 font-medium uppercase tracking-wide">
                                <i class="fas fa-map-marker-alt text-brand"></i> <span id="profile-location">India</span>
                            </div>
                        </div>

                        <div class="mt-6 flex gap-3">
                            <a id="btn-github" href="#" target="_blank" class="flex-1 flex items-center justify-center gap-2 bg-gray-900 dark:bg-black text-white py-2.5 rounded-xl font-medium hover:opacity-90 transition shadow-lg shadow-gray-200 dark:shadow-none">
                                <i class="fab fa-github text-lg"></i> GitHub
                            </a>
                            <a id="btn-email" href="#" class="w-12 flex items-center justify-center bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                <i class="fas fa-envelope text-lg"></i>
                            </a>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 dark:border-gray-700 p-4 bg-gray-50/50 dark:bg-gray-700/30">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-100 dark:border-gray-600 flex items-center justify-center text-brand text-lg">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-xs font-bold text-gray-400 uppercase">Education</h4>
                                <p id="profile-uni" class="text-sm font-semibold text-gray-800 dark:text-gray-200 truncate w-48">Not Set</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-6 flex-1 lg:hidden">
                    <h3 class="font-bold text-gray-900 dark:text-white mb-2">About</h3>
                    <p id="profile-bio-mobile" class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed">Loading bio...</p>
                </div>
            </aside>

            <main class="lg:col-span-8 xl:col-span-9 h-full overflow-y-auto pb-20 pr-1">
                
                <div class="glass-panel rounded-2xl p-6 mb-6 hidden lg:block">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                        <i class="far fa-user-circle text-brand"></i> About Me
                    </h3>
                    <p id="profile-bio" class="text-gray-600 dark:text-gray-300 leading-7">No bio added yet.</p>
                </div>

                <div class="mb-8">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-rss text-brand"></i> Recent Activity
                    </h3>
                    <div id="posts-container" class="flex overflow-x-auto gap-4 pb-4 no-scrollbar">
                        <div class="w-full text-center py-10 bg-white dark:bg-gray-800 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700 text-gray-400">Loading posts...</div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2">
                            <i class="fas fa-layer-group text-brand"></i> Projects
                        </h3>
                    </div>
                    <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                        <div class="col-span-full text-center py-10 bg-white dark:bg-gray-800 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700 text-gray-400">Loading projects...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg transition-colors duration-300">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 rounded-t-2xl">
                <h3 class="font-bold text-gray-800 dark:text-white">Edit Profile</h3>
                <button onclick="toggleEditModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">First Name</label>
                        <input id="edit-fname" type="text" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-brand">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Last Name</label>
                        <input id="edit-lname" type="text" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-brand">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Headline</label>
                    <input id="edit-headline" type="text" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-brand">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">University</label>
                    <input id="edit-uni" type="text" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-brand">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bio</label>
                    <textarea id="edit-bio" class="w-full bg-gray-50 dark:bg-gray-700 dark:text-white border border-gray-200 dark:border-gray-600 rounded-lg p-2.5 h-24 resize-none outline-none focus:ring-2 focus:ring-brand"></textarea>
                </div>
                <button onclick="saveProfile()" class="w-full bg-brand text-white font-bold py-3 rounded-xl hover:bg-brandDark transition">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- THEME TOGGLER LOGIC ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Apply theme on load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        // --- FIREBASE LOGIC ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLafxMmbSanvmgP9KPvWXO7968BgkSMAQ",
            authDomain: "skillxchange-93fac.firebaseapp.com",
            projectId: "skillxchange-93fac",
            storageBucket: "skillxchange-93fac.firebasestorage.app",
            messagingSenderId: "363649168062",
            appId: "1:363649168062:web:a938e95d8c7a684a1de4ef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        const params = new URLSearchParams(window.location.search);
        const profileUid = params.get("uid");
        let currentUser = null;

        auth.onAuthStateChanged(async (user) => {
            if (!user && !profileUid) return window.location.href = "login.html";
            currentUser = user;
            const uidToLoad = profileUid || user.uid;
            const isOwner = !profileUid || profileUid === user?.uid;

            if (isOwner) document.getElementById("photo-overlay").classList.remove("hidden");
            else document.getElementById("edit-profile-btn").style.display = "none";

            const doc = await db.collection("users").doc(uidToLoad).get();
            if (doc.exists) {
                const data = doc.data();
                updateUI(data, user?.email || "");
                loadPosts(uidToLoad);
                loadProjects(`${data.firstName} ${data.lastName}`);
            }
        });

        function updateUI(data, email) {
            const fullName = `${data.firstName} ${data.lastName}`;
            const initial = data.firstName.charAt(0).toUpperCase();
            
            document.getElementById("profile-name").innerText = fullName;
            document.getElementById("profile-headline").innerText = data.headline || "Student";
            document.getElementById("profile-uni").innerText = data.university || "University not set";
            document.getElementById("profile-bio").innerText = data.bio || "No bio yet.";
            document.getElementById("profile-bio-mobile").innerText = data.bio || "No bio yet.";
            document.getElementById("nav-avatar").innerText = initial;

            const imgTag = document.getElementById("profile-img-tag");
            const avatarText = document.getElementById("profile-avatar-text");

            if (data.photoURL) {
                imgTag.src = data.photoURL;
                imgTag.classList.remove("hidden");
                avatarText.classList.add("hidden");
            } else {
                avatarText.innerText = initial;
                imgTag.classList.add("hidden");
                avatarText.classList.remove("hidden");
            }

            // Pre-fill modal
            document.getElementById("edit-fname").value = data.firstName || "";
            document.getElementById("edit-lname").value = data.lastName || "";
            document.getElementById("edit-uni").value = data.university || "";
            document.getElementById("edit-bio").value = data.bio || "";
            document.getElementById("edit-headline").value = data.headline || "";
        }

        async function uploadPhoto(input) {
            if (!input.files || !input.files[0] || !currentUser) return;
            const file = input.files[0];
            const ref = storage.ref(`profile_photos/${currentUser.uid}`);
            
            try {
                const snap = await ref.put(file);
                const url = await snap.ref.getDownloadURL();
                await db.collection("users").doc(currentUser.uid).update({ photoURL: url });
                location.reload();
            } catch (e) { alert("Upload failed"); }
        }

        function loadPosts(uid) {
            db.collection("questions").where("uid", "==", uid).get().then(snap => {
                const container = document.getElementById("posts-container");
                container.innerHTML = snap.empty ? '<p class="text-gray-400 italic">No posts yet.</p>' : "";
                snap.forEach(doc => {
                    const post = doc.data();
                    container.innerHTML += `
                        <div class="snap-center shrink-0 w-80 bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                            <span class="text-xs text-gray-400">${post.tag}</span>
                            <h4 class="font-bold text-gray-800 dark:text-white mt-1">${post.title}</h4>
                            <div class="mt-3 text-xs text-brand font-semibold">❤️ ${post.likes || 0} Likes</div>
                        </div>`;
                });
            });
        }

        function loadProjects(username) {
            db.collection("projects").where("author", "==", username).get().then(snap => {
                const grid = document.getElementById("projects-grid");
                grid.innerHTML = snap.empty ? '<div class="col-span-full p-6 text-center text-gray-400 border border-dashed border-gray-300 dark:border-gray-700 rounded-xl">No projects.</div>' : "";
                snap.forEach(doc => {
                    const p = doc.data();
                    grid.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition group">
                            <div class="h-24 bg-gray-100 dark:bg-gray-700 flex items-center justify-center group-hover:bg-brandLight dark:group-hover:bg-gray-600 transition">
                                <i class="fas fa-laptop-code text-3xl text-gray-300 dark:text-gray-500 group-hover:text-brand"></i>
                            </div>
                            <div class="p-5">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-1 truncate">${p.title}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 h-8 mb-3">${p.description}</p>
                            </div>
                        </div>`;
                });
            });
        }

        function toggleEditModal() {
            const m = document.getElementById("edit-modal");
            m.classList.toggle("hidden");
            m.classList.toggle("flex");
        }

        function saveProfile() {
            if (!currentUser) return;
            const updates = {
                firstName: document.getElementById("edit-fname").value,
                lastName: document.getElementById("edit-lname").value,
                university: document.getElementById("edit-uni").value,
                bio: document.getElementById("edit-bio").value,
                headline: document.getElementById("edit-headline").value
            };
            db.collection("users").doc(currentUser.uid).update(updates).then(() => {
                alert("Saved!");
                location.reload();
            });
        }
    </script>
</body>
</html>